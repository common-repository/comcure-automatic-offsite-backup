var cp={};
jQuery(function($){cp.cp_data=new Array;cp.content=$("#comcure");cp.zp=function(num,c){var n=num+"";if(n.length<c)n="0"+n;return n};cp.get_storage_info=function(storage_id){var storages={30:{name:"SLC3"},31:{name:"ATL1"},32:{name:"AMS1"},39:{name:"LDN1"},40:{name:"LDN2"},41:{name:"SLC1"},45:{name:"ATL1"}};return storages[storage_id]};cp.get_location_info=function(location_id){var locations={1:{name:"London - UK",icon:"https://comcure-uk2.netdna-ssl.com/images/icons/flag-uk.png?1339040567"},2:{name:"Salt Lake City, Utah - USA",
icon:"https://comcure-uk2.netdna-ssl.com/images/icons/flag-usa.png?1339040567"},3:{name:"Atlanta, Georgia - USA",icon:"https://comcure-uk2.netdna-ssl.com/images/icons/flag-usa.png?1339040567"},4:{name:"Amsterdam - Netherlands",icon:"https://comcure-uk2.netdna-ssl.com/images/icons/flag-nl.png?1339040567"}};return locations[location_id]};cp.format_date=function(time,format){var monthNames=new Array("January","February","March","April","May","June","July","August","September","October","November","December");
var dayNames=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday");time=time?new Date(time*1E3):new Date;if(!format)format="dd MMM yyyy HH:mm";return format.replace(/(yyyy|MMMM|MMM|MM|dddd|ddd|dd|HH|mm|ss|a\/p)/gi,function($1){switch($1){case "yyyy":return time.getFullYear();case "MMMM":return monthNames[time.getMonth()];case "MMM":return monthNames[time.getMonth()].substr(0,3);case "MM":return cp.zp(time.getMonth()+1,2);case "dddd":return dayNames[time.getDay()];case "ddd":return dayNames[time.getDay()].substr(0,
3);case "dd":return cp.zp(time.getDate(),2);case "HH":return cp.zp(time.getHours(),2);case "mm":return cp.zp(time.getMinutes(),2);case "ss":return cp.zp(time.getSeconds(),2);case "a/p":return time.getHours()<12?"a":"p"}});return time.toString(format)};cp.localize_time=function(time,reverse){if(time&&time.match(/\d{1,2}:\d{1,2}/)){var parts=time.split(/:/);var hour=parseInt(parts[0],10);var min=parseInt(parts[1],10);var date=new Date;var mins=hour*60+min;if(reverse)mins+=date.getTimezoneOffset();else mins-=
date.getTimezoneOffset();hour=Math.floor(mins/60);if(hour<0)hour+=24;else if(hour>=24)hour-=24;time=cp.zp(hour,2)+":"+cp.zp(Math.abs(mins)%60,2)}else time="";return time};cp.format_size=function(bytes,noEmpty){var sizes=["B","KB","MB","GB","TB"];if(bytes==null)bytes=0;if(bytes==0&&!noEmpty)return"0 B";var i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)));if(i>0)return(bytes/Math.pow(1024,i)).toFixed(2)+" "+sizes[i];else return bytes+"B"};cp.escape_html=function(html){return html.replace(/&/g,
"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};cp.get=function(){return cp.cp_data[0]};cp.format_size_html=function(bytes,noEmpty){return'<span title="'+bytes+' bytes">'+cp.format_size(bytes,noEmpty)+"</span>"};cp.get_uri=function(){return decodeURIComponent(location.search.substr(1)).split("&")};cp.get_page=function(){var el;return el=cp.get_uri(),el=el[0].split("="),el=el[1].split("-"),el=el[1]};cp.get_domain=function(key){var el=cp.get_uri(),data=
cp.get();if(typeof el[1]!="undefined")return el=el[1].split("="),el=el[1];if(!key)key=0;if(typeof data.sites=="undefined"||data.sites.length==0)return"";return data.sites[key].domain};cp.init=function(callback){var j=0,el=cp.get_page();$blockUI("Initializing . . .");$("#domain").hide();$.getJSON("plugins.php?page=comcure-overview&action=cp_data",function(json){if(!json.result)cp.flash(json.reason);else{callback(json.data);var domain=cp.get_domain();$("#domain > option").remove();for(var i in json.data.sites){$("#domain").append($("<option>").text(json.data.sites[i].domain).attr("value",
i)).fadeIn();if(domain&&json.data.sites[i].domain==domain){j=i;$("#domain option").eq(i).attr("selected",true)}}if(typeof json.data.sites[0]!="undefined"){if(!domain)domain=json.data.sites[0].domain;cp.wrapper(el,json.data.sites[j],domain);$(".overview").fadeIn()}else{$blockUI("Adding site . . .");$.getJSON("plugins.php?page=comcure-settings&action=add_website",function(json){if(!json.result){$unblockUI();cp.flash(json.reason)}else document.location="plugins.php?page=comcure-settings&domain="+json.data.domain})}}$unblockUI()})};
cp.init(function(data){cp.cp_data.push(data)});cp.load_snapshots=function(domain,key){var cron={1:"Daily",3:"Weekly",4:"Monthly",2:"On-Demand"},sel_snapshots=$("#snapshots");$blockUI("Loading snapshot . . .");$.getJSON("plugins.php?page=comcure-backups&action=list_snapshots&domain="+domain,function(json){$("#list_snapshots").hide();if(!json.result)cp.flash(json.reason);else{var ids={},snapshots={},versions=[];sel_snapshots.empty();$.each(cron,function(index,label){var optgroup=$("<optgroup/>");sel_snapshots.append(optgroup.attr({"label":label,
"id":index}));$.each(json.data,function(id,item){if(item.cron_id==index){optgroup.append($("<option/>").attr({"value":item.version,"id":id}).text(cp.format_date(item.version)));ids[index]=item.cron_id;versions.push(item.version);snapshots[item.version]=item}});if(typeof ids[index]!=undefined&&ids[index]!=index)sel_snapshots.find("#"+index).hide()});sel_snapshots.fadeIn();var max_ver=function(array){return Math.max.apply(Math,array)},total_size=0;key=!key?max_ver(versions):key;if(typeof snapshots[key]==
"undefined"){$("#list_databases").hide();$("#list_snapshots").hide();$("#snapshots").hide();$unblockUI();return false}if(snapshots[key].report!=null)total_size=cp.format_size(snapshots[key].report.total_size);$(".list_snapshots > tbody").empty();$(".list_snapshots > tbody").append($("<tr/>").append($("<td/>").css({"width":"200px"}).html(cron[snapshots[key].cron_id])).append($("<td/>").html(cp.format_date(key))).append($("<td/>").html(total_size)).append($("<td/>").addClass("restore").append($("<a/>").attr({"target":"_blank",
"id":snapshots[key].id}).text("Restore Snapshot"))));cp.toggle(".list_snapshots");$(".list_snapshots > tbody").find("a").bind("click dblclick",function(){if(confirm("Do you really want to restore this snapshot to your host?\nThis will overwrite your latest data.")){$blockUI("Restoring Snapshot . . .");$.getJSON("plugins.php?page=comcure-backups&action=restore_snapshot&domain="+domain+"&id="+$(this).attr("id"),function(json){if(!json.result)cp.flash(json.reason);else cp.flash("The snapshot is being restored now.");
$unblockUI()})}});$("#list_snapshots").fadeIn();$("#snapshots").find("option[value="+key+"]").attr("selected",true);cp.load_databases(domain,$("#snapshots").find(":selected")[0].id)}$unblockUI()})};$("#snapshots").change(function(){var domain=cp.get_domain();cp.load_snapshots(domain,$(this).val())});cp.load_databases=function(domain,id){var dbs;$(".list_databases").hide();$("#list_databases").find(".loader").fadeIn();$(".list_databases > tbody").empty();$.getJSON("plugins.php?page=comcure-backups&action=list_databases&domain="+
domain+"&id="+id,function(json){if(!json.result)cp.flash(json.reason);else{if(json.data.length==0){$("#list_databases").hide().find(".loader").hide();return false}var dbs={};$.each(json.data,function(key,value){dbs[value.name]=value});$("#list_databases").find(".loader").hide();cp.render_databases(dbs)}})};cp.render_databases=function(dbs){var count=$.map(dbs,function(n,i){return i}).length,size=0;if(count>0){$.each(dbs,function(key,db){var size=typeof db.overview=="undefined"?db.size:db.overview.size;
var type=typeof db.type=="undefined"?"MySQL":db.type;var id=typeof db.id=="undefined"?db.db_id:db.id;$(".list_databases > tbody").append($("<tr/>").append($("<td/>").css({"width":"200px","font-weight":"bold"}).html(db.name)).append($("<td/>").html(cp.format_size(size))).append($("<td/>").html(type=="mysql"?"Mysql":type)).append($("<td/>").addClass("restore").append($("<a/>").attr({"target":"_blank","id":db.name}).text("Restore Database"))))});cp.toggle(".list_databases");$(".list_databases > tbody").find("a").bind("click dblclick",
function(){var domain=cp.get_domain(),name=$(this).attr("id");if(confirm("Please confirm you want to restore database '"+name+"'.\nThis will overwrite current data on your server")){$blockUI("Restoring Database . . .");$.post("plugins.php?page=comcure-backups&action=restore_database&domain="+domain,{snapshot:$("#snapshots").find(":selected")[0].id,name:name},function(json){if(!json.result)cp.flash(json.reason);else cp.flash("The database is being restored now.");$unblockUI()},"json")}});$("#list_databases, .list_databases").fadeIn()}};
cp.settings=function(data){if(typeof data!="undefined"){if(typeof data.host_info!="undefined")$.each(data.host_info,function(key,value){$("#"+key).attr("value",value)});cp.get_databases(data.domain);$("#form-database-settings").find("#save-database").fadeIn()}else $("#form-database-settings").find("#save-database").hide();$(".nav-tab-wrapper").parent().find("a").removeClass("nav-tab-active");$(".nav-tab-wrapper a#settings").addClass("nav-tab-active");$("#comcure-settings").fadeIn()};cp.overview=function(){var data=
cp.get(),sites=data.sites,service=data.service,user=data.user,account=data.account,databases=0;$(".welcome").html("Welcome, "+account.first_name+" "+account.last_name+".");$(".total_price").html("$"+service.billing.price+"/month");$(".websites > tbody").empty();for(var i in sites){var count_dbs=function(o){var size=0,key;for(key in o)if(o.hasOwnProperty(key))size++;return size};databases+=count_dbs(sites[i].databases);$(".websites > tbody").append($("<tr/>").append($("<td/>").append($("<a/>").addClass("site").attr("id",
i).text(sites[i].domain).click(function(){history.replaceState(false,false,"plugins.php?page=comcure-backups&domain="+$(this).text());$(".nav-tab-wrapper").parent().find("a").removeClass("nav-tab-active");$(".nav-tab-wrapper a#backups").addClass("nav-tab-active");$("#domain").find("option").removeAttr("selected").eq($(this).attr("id")).attr("selected",true);return cp.wrapper("comcure-backups",sites[i],$(this).text())}))).append($("<td/>").text(cp.format_size(sites[i].disk_usage))).append($("<td/>").text(sites[i].inode_usage)))}if(service.specs.antivirus)$("#anti_virus_scanning").html("Yes");
if(service.specs.encryption)$("#encrypted_backups").html("Yes");if(service.specs["two-step_auth"])$("#two_factor_authentication").html("Yes");$("#service_plan_name").html(service.billing.service_plan_name);var percent={websites:(sites.length/service.specs.sites*100).toFixed(2),databases:(databases/service.specs.databases*100).toFixed(2),disk_space:(user.disk_usage/user.quota*100).toFixed(2),inodes:(user.inode_usage/user.inode_quota*100).toFixed(2)};$("#websites .gauge_bar").html(sites.length+" of "+
service.specs.sites+" ("+percent.websites+"%)").css({"width":percent.websites+"%"});$("#disk_space .gauge_bar").html(cp.format_size(user.disk_usage,true)+" of "+cp.format_size(user.quota)+" ("+percent.disk_space+"%)").css({"width":percent.disk_space+"%"});$("#databases .gauge_bar").html(databases+" of "+service.specs.databases+" ("+percent.databases+"%)").css({"width":percent.databases+"%"});$("#inodes .gauge_bar").html((user.inode_usage==null?0:user.inode_usage)+" of "+user.inode_quota+" ("+percent.inodes+
"%)").css({"width":percent.inodes+"%"})};cp.load_events=function(domain,lock){$(".events").hide();if(lock)$("#events").find(".loader").show();$.getJSON("plugins.php?page=comcure-backups&action=load_events&domain="+domain,function(json){if(!json.result)cp.flash(json.reason);else{$(".events > tbody").empty();$.each(json.data,function(i,e){if(e.action=="u"||e.action=="b"){e.action="Snapshot";e.descr="<b>"+e.descr+"</b> snapshot ";if(e.type=="ftp"){e.descr=e.descr+"(<i>files</i>), fetched "+cp.format_size(e.report.total_size);
if(e.report.inf_files)e.descr=e.descr+" - "+e.report.inf_files+" infected file(s)"}if(e.type=="mysql")e.descr=e.descr+" (<i>database: <b>"+e.dbname+"</b></i>) fetched "+cp.format_size(e.report.total_size)}if(e.action=="r"){e.action="Restore";if(e.type=="ftp")e.descr="Path <b>"+cp.escape_html(e.path)+"</b>";if(e.type=="mysql")e.descr="Database <b>"+e.dbname+"</b>";e.descr=e.descr+" as of <b>"+cp.format_date(e.version)+"</b>"}if(e.status=="i")if(e.event!="Finished successfully")e.event=cp.escape_html(e.event)+
" - still working";else e.event=cp.escape_html(e.event);$(".events > tbody").append($("<tr/>").attr("id",i).append($("<td/>").text(cp.format_date(e.version))).append($("<td/>").text(e.action)).append($("<td/>").html(e.descr.toString())).append($("<td/>").html(e.event)));if(e.status=="e")$(".events > tbody").find("tr#"+i).css({"color":"red"});if(e.status=="i")if(e.event!="Finished successfully")$(".events > tbody").find("tr#"+i).css({"color":"green"})})}$("#events").find(".loader").hide();$(".events").fadeIn()})};
cp.backups=function(data){var location_info=cp.get_location_info(data.location_id);$("#storeage_ip").html(data.storage_ip);$("#created").html(cp.format_date(data.created_ts));if(typeof data.last_ondemand_snapshot!="undefined"){$("#last_ondemand_snapshot").find("span").remove();$("#last_ondemand_snapshot").prepend($("<span/>").css({"margin-right":"5px"}).html(cp.format_date(data.last_ondemand_snapshot.created))).find("a").html("Force Backup Now")}else $("#last_ondemand_snapshot").find("a").html("Force Backup Now");
$("#disk_usage").html(cp.format_size(data.disk_usage));$("#monthly_traffic").html(cp.format_size(data.monthly_traffic));if(typeof location_info!="undefined")$("#storage_location").html('<img src="'+location_info.icon+'" /><span>'+location_info.name+" ("+cp.get_storage_info(data.storage_id).name+")</span>");if(typeof data.last_snapshot!="undefined")$("#last_snapshot").html(cp.format_date(data.last_snapshot.created));$("#comcure-backups").fadeIn()};cp.logout=function(){$.get("plugins.php?page=comcure-overview&action=logout",
function(json){window.location.href="plugins.php?page=comcure-overview"},"json")};cp.wrapper=function(page,data,domain){$(".comcure").hide();if(page=="overview")cp.overview();else if(page=="settings")cp.settings(data);else{cp.backups(data);cp.load_snapshots(domain);setTimeout(function(){cp.load_events(domain,true)},4E3)}$("#comcure-"+page).fadeIn()};cp.flash=function(message){if(message=="Not authenticated."){cp.logout();return false}$("#flash-message p strong").html(message);$("#flash-message").fadeIn().fadeOut(1E4)};
cp.render_db_list=function(data,remove,disabled){var db_list="#database-list",sites=cp.get().sites,agent={},domain=cp.get_domain();for(var i in sites)if(sites[i].domain==domain)agent=sites[i].database_agents;if(!domain)agent=sites[0].database_agents;var key=Object.keys(agent).filter(function(key){return key})[0];if(typeof agent[key]!="undefined")$("#form-database-settings").find("#agent_id").attr("value",agent[key].agent_id);$(db_list+" > tbody").empty();$.each(data.databases,function(key,database){$(db_list+
" > tbody").append($("<tr/>").attr({"valign":"top","id":key}).append($("<th/>").append($("<input/>").attr({"value":database,"type":"text","name":"database[]"})).attr({"scope":"row"})).append($("<td/>").append($("<input/>").attr({"id":key,"type":"submit","class":"button button-primary rm_db","value":"Remove"}))))});$(db_list).find("input[type=text]").attr("disabled",true);$(db_list).find(".rm_db").bind("click dblclick",function(){var row=db_list+" > tbody > tr",el=row+"#"+$(this).attr("id"),db_name=
$(el).find("input[type=text]").attr("value"),domain=cp.get_domain();if(remove){if($(row).length==1)return false;$(el).remove();return false}if(confirm("Are you certain you wish to remove the database '"+db_name+"'?\nRemoving this database will permanently delete your database backups.")){$(el).remove();$blockUI("Deleteing Database "+db_name+" . . .");$.post("plugins.php?page=comcure-settings&action=remove_database&domain="+domain,{db_name:db_name},function(json){if(!json.result)cp.flash(json.reason);
else{$(el).remove();if($(db_list+" > tbody").find("tr").length==0)cp.load_database(json.data.databases,true);else cp.get_databases(domain);cp.flash("The database '"+db_name+"' has been permanently deleted.")}$unblockUI()},"json")}return false})};cp.get_agent=function(domain){var sites=cp.get().sites,agent={};for(var i in sites)if(sites[i].domain==domain)agent=sites[i].database_agents;if(!domain)agent=sites[0].database_agents;return Object.keys(agent).filter(function(key){return key})[0]};cp.get_databases=
function(domain){$blockUI("Updating database list . . .");$.getJSON("plugins.php?page=comcure-overview&action=get_databases&domain="+domain,function(json){if(!json.result)cp.flash(json.reason);else if(json.data.databases.length==0)cp.load_database(null,true);else{var db=new Array,bt=new Array;for(var key in json.data.databases){db.push(key);bt.push(cp.localize_time(json.data.databases[key].backup_time))}$("#form-database-settings").find("#save-database").hide();cp.render_db_list({"result":true,"databases":$.extend({},
db),"backup_time":$.extend({},bt)},false,true)}$unblockUI()});return false};cp.load_database=function(data,load,fresh){var action="show_databases",agent_id=0,domain=cp.get_domain();if(fresh)cp.get_databases(domain);if(typeof cp.get_agent(domain)!="undefined")agent_id=cp.get_agent(domain);if(domain.replace(/^www./,"")!=window.location.host.replace(/^www./,"")){action="show_remote_databases";if(!agent_id){$("#form-database-settings").find("p").hide();$("#form-database-settings").html('<a href="https://manage.comcure.com" target="_blank">Install Database Agent</a>')}}var i=
0;for(var database in data)if(data.hasOwnProperty(database))i++;if(i==0){if(load){$blockUI("Updating list of databases . . .");$.getJSON("plugins.php?page=comcure-settings&action="+action+"&domain="+domain+"&agent_id="+parseInt(agent_id),function(json){if(!json.result)cp.flash(json.reason);else cp.render_db_list(json,true);$unblockUI()})}$("#form-database-settings").find("#save-database").fadeIn()}else{var db=new Array,bt=new Array;for(var key in data){db.push(key);bt.push(cp.localize_time(data[key].backup_time))}$("#form-database-settings").find("#save-database").hide();
cp.render_db_list({"result":true,"databases":$.extend({},db),"backup_time":$.extend({},bt)},false,true)}};cp.toggle=function(el){$(el+" > tbody").find("tr").bind("mouseover mouseout",function(){var download=$(this).find("a");if(typeof download!=undefined)download.toggle()})};cp.content.find("#comcure-settings h2 a").bind("click dblclick",function(){var el=$(this),tag=el.parent();$("#comcure-settings").find("form").hide();$("#install-db-agent").hide();$("#form-"+el.attr("id")).fadeIn();tag.find("a").removeClass("active");
el.addClass("active").prependTo(tag)});cp.content.find("#form-database-settings").submit(function(){var domain=cp.get_domain(),backup_time=new Array,databases=new Array,agent_id=0,error=false;$("#form-database-settings :input").each(function(){var name=this.name.substr(0,this.name.length-2);if(name=="backup_time")backup_time.push(cp.localize_time(this.value,true));if(this.name=="agent_id")agent_id=this.value;if(name=="database"){if(this.value==""){$("#form-database-settings").find("#db-"+this.id).remove();
error=true}databases.push(this.value)}});if(error)return false;$blockUI("Saving Database Settings . . .");$.post("plugins.php?page=comcure-settings&action=database_settings&domain="+domain,{"agent_id":agent_id,"databases":databases,"backup_time":backup_time},function(json){if(!json.result)cp.flash(json.reason);else{cp.flash("Database Settings Updated");if(agent_id!="")$.post("plugins.php?page=comcure-settings&action=sync_agent&domain="+domain,{"agent_id":agent_id},function(json){if(!json.result)cp.flash(json.reason);
else cp.flash("The Comcure Backup Agent files have been updated.")},"json");cp.load_database(json.data.databases,false,true)}$unblockUI()},"json");return false});cp.content.find("#form-website-settings").submit(function(){var domain=cp.get_domain(),action="update",host=$(this),error=false;$.each(host.serializeArray(),function(i,item){if(item.name!="host_id")if(item.value==""&&item.name!="backup_time"&&item.name!="priv_key"&&item.name!="pass"){$("#"+item.name).css({"border":"1px red solid"});error=
true}});if(error)return false;if($("#host_id").val()==""){action="save";$blockUI("Saving "+domain+" Settings . . .")}else $blockUI("Updating "+domain+" Settings . . .");$.post("plugins.php?page=comcure-settings&action="+action+"_settings&domain="+domain,host.serialize(),function(json){if(!json.result)cp.flash(json.reason);else{$("#host_id").attr("value",json.data.host_id);cp.flash("Settings Updated");if(action=="save"){$("#form-website-settings").hide();cp.get_databases(domain);$("#form-database-settings").fadeIn()}}$unblockUI()},
"json");return false});cp.content.find("#website-settings :input").bind("keydown focus",function(){$(this).css({"border":"1px solid rgb(51, 51, 51)"})});cp.content.find("#website-settings :input").bind("blur",function(){$(this).css({"border":"1px solid #dfdfdf"})});cp.content.find(".ondemand_snapshot_site").bind("click dblclick",function(){if(confirm("Are you certain you wish to request on-demand backup?")){var domain=cp.get_domain();$blockUI("Please wait ...");$.get("plugins.php?page=comcure-backups&action=on_demand&domain="+
domain,function(json){if(!json.result)cp.flash(json.reason);else cp.flash('The site "<strong>'+domain+'</strong>" has been scheduled for a backup.');$unblockUI()},"json")}});cp.content.find(".nav-tab-wrapper a").bind("click dblclick",function(){var el=$(this),page=el.attr("id"),domain=cp.get_domain(),sites=cp.get().sites,j=0;if(page=="logout"){if(confirm("Are you sure you wish to log out?"))cp.logout();return false}if(typeof sites[0]!="undefined"){for(var i in sites)if(sites[i].domain==domain)j=i;
if(!domain)domain=sites[0].domain;el.parent().find("a").removeClass("nav-tab-active");el.addClass("nav-tab-active");history.replaceState(false,false,"plugins.php?page=comcure-"+page+"&domain="+domain);return cp.wrapper(page,sites[j],domain)}});cp.content.find("#private-key").click(function(){$("#priv_key, #priv-key-desc").toggle()});cp.content.find("#preferences").click(function(){$("#form-preferences").toggle()});cp.content.find("#protocol").change(function(){$("#port").attr("value",$(this).val()==
"sftp"?22:21)});cp.content.find("#domain").change(function(){var key=$(this).val(),sites=cp.get().sites,domain=sites[key].domain,page=cp.get_page();history.replaceState(false,false,"plugins.php?page=comcure-"+page+"&domain="+domain);return cp.wrapper(page,sites[key],domain)});cp.content.find(".handlediv").click(function(){$(this).parents(".postbox-cantainer").find("table").first().toggle()})});
